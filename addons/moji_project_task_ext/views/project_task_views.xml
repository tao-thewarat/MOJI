<?xml version="1.0" encoding="utf-8" ?>
<odoo>
  <record id="view_task_form2" model="ir.ui.view">
    <field name="name">project.task.form.inherit</field>
    <field name="model">project.task</field>
    <field name="priority">40</field>
    <field name="inherit_id" ref="project.view_task_form2" />
    <field name="arch" type="xml">
      <xpath expr="//h1//field[@name='priority']" position="attributes">
        <attribute name="invisible">1</attribute>
      </xpath>
      <xpath expr="//field[@name='user_ids']" position="before">
        <field name="reporter_id" readonly="1" />
      </xpath>
      <xpath expr="//field[@name='milestone_id']" position="attributes">
        <attribute name="invisible">1</attribute>
      </xpath>
      <xpath expr="//field[@name='partner_id']" position="attributes">
        <attribute name="invisible">1</attribute>
      </xpath>
      <xpath expr="//div[@id='date_deadline_and_recurring_task']" position="after">
        <field name="task_category" />
        <field
          name="parent_defect_id"
          string="Defect from"
          options="{'no_create': True}"
        />
      </xpath>
      <xpath expr="//field[@name='name']" position="attributes">
        <attribute name="default_focus">1</attribute>
      </xpath>
      <xpath
        expr="//page[@name='sub_tasks_page']//field[@name='child_ids']//list"
        position="attributes"
      >
        <attribute name="editable" />
      </xpath>
      <xpath
        expr="//page[@name='sub_tasks_page']//field[@name='child_ids']"
        position="attributes"
      >
        <attribute name="widget">one2many</attribute>
        <attribute name="context">
                    {
                    'default_project_id': project_id,
                    'default_display_in_project': False,
                    'default_user_ids': user_ids,
                    'default_parent_id': id,
                    'default_partner_id': partner_id,
                    'default_is_defect': False,
                    'default_milestone_id': allow_milestones and milestone_id
                    }
                </attribute>
        <attribute name="options">
                    {
                    'open_create': True,
                    'form_view_ref': 'project.view_task_form2',
                    'target': 'current'
                    }
                </attribute>
        <attribute name="mode">list,kanban,form</attribute>
      </xpath>

      <xpath expr="//page[@name='sub_tasks_page']" position="before">
        <page name="defect_tasks_page" string="Defect Task" invisible="not project_id">
          <field
            name="defect_ids"
            mode="list,kanban,form"
            context="{
                            'default_project_id': project_id,
                            'default_user_ids': user_ids,
                            'default_parent_id': id,
                            'default_partner_id': partner_id,
                            'default_milestone_id': allow_milestones and milestone_id,
                            'default_task_category': 'defect',
                            'default_is_defect': True,
                            'kanban_view_ref': 'project.project_sub_task_view_kanban_mobile',
                            'closed_X2M_count': closed_subtask_count
                        }"
            options="{'open_create': True, 'form_view_ref': 'project.view_task_form2', 'target': 'current'}"
          >
            <list
              decoration-muted="state in ['1_done','1_canceled']"
              open_form_view="True"
            >
              <field name="sequence" widget="handle" />
              <field name="id" optional="hide" options="{'enable_formatting': False}" />
              <field name="parent_id" column_invisible="True" />
              <field name="priority" widget="priority" nolabel="1" width="20px" />
              <field
                name="state"
                widget="project_task_state_selection"
                nolabel="1"
                width="20px"
              />
              <field name="name" widget="name_with_defect_count" />
              <field name="defect_count" column_invisible="True" />
              <field
                name="project_id"
                string="Project"
                optional="hide"
                options="{'no_open': 1}"
                widget="project"
              />
              <field name="user_ids" widget="many2many_avatar_user" optional="show" />
              <field
                name="date_deadline"
                invisible="state in ['1_done', '1_canceled']"
                optional="hide"
                decoration-danger="date_deadline and date_deadline &lt; current_date"
              />
              <field
                name="tag_ids"
                widget="many2many_tags"
                options="{'color_field': 'color'}"
                optional="hide"
              />
              <field
                name="stage_id"
                optional="show"
                context="{'default_project_id': project_id}"
              />
              <field name="is_defect" column_invisible="True" />
            </list>
          </field>
        </page>
      </xpath>
      <xpath
        expr="//button[@name='%(project.project_task_action_sub_task)d']//div//span[1]"
        position="attributes"
      >
        <attribute name="invisible">1</attribute>
      </xpath>
      <xpath
        expr="//button[@name='%(project.project_task_action_sub_task)d']//div//span[2]"
        position="attributes"
      >
        <attribute name="invisible">1</attribute>
      </xpath>
      <xpath
        expr="//button[@name='%(project.project_task_action_sub_task)d']//div"
        position="inside"
      >
        <span class="o_stat_text">
          <field name="subtask_count" nolabel="1" />
          <span> Sub-tasks</span>
        </span>
      </xpath>
      <xpath expr="//div[@name='button_box']" position="inside">
        <button
          name="action_open_defect_task"
          type="object"
          class="oe_stat_button"
          icon="fa-bars"
          invisible="not id or defect_count == 0"
          context="{
                        'default_project_id': project_id,
                        'default_display_in_project': False,
                        'default_user_ids': user_ids,
                        'default_milestone_id': milestone_id,
                        'subtask_action': True,
                    }"
        >
          <div class="o_field_widget o_stat_info">
            <span class="o_stat_text">
              <field name="defect_count" nolabel="1" />
              <span> Defect-tasks</span>
            </span>
          </div>
        </button>
      </xpath>
    </field>
  </record>

  <record id="view_task_kanban" model="ir.ui.view">
    <field name="name">project.task.kanban.inherit</field>
    <field name="model">project.task</field>
    <field name="inherit_id" ref="project.view_task_kanban" />
    <field name="arch" type="xml">
      <xpath expr="//kanban" position="attributes">
        <attribute name="on_create" />
      </xpath>
    </field>
  </record>

  <record id="view_task_tree2" model="ir.ui.view">
    <field name="name">project.task.list.inherit.hide.stage_id</field>
    <field name="model">project.task</field>
    <field name="inherit_id" ref="project.view_task_tree2" />
    <field name="arch" type="xml">
      <xpath expr="//list" position="attributes">
        <attribute name="default_group_by" />
      </xpath>
    </field>
  </record>

  <record id="project.project_task_action_sub_task" model="ir.actions.act_window">
    <field
      name="domain"
    >[('id', 'child_of', active_id), ('id', '!=', active_id), ('is_defect',
            '=', False)]</field>
  </record>
</odoo>
